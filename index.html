<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Lost & Found</title>
    <script src="https://cdn.tailwindcss.com"></script>
    

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container, .item-card {
            transition: all 0.3s ease-in-out;
        }
        .form-container:hover, .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .claimed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 0.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .item-card:hover .claimed-overlay {
            opacity: 1;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6d28d9; /* purple-700 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Campus Lost & Found</h1>
            <p class="text-gray-600 mt-2">Helping you find what you've lost and return what you've found.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Report Lost Item Form -->
            <div id="lost-form-container" class="form-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Report a Lost Item</h2>
                <form id="lost-item-form">
                    <input type="text" id="lost-item-name" placeholder="Item Name (e.g., Black Wallet)" class="w-full p-2 mb-4 border rounded-md transition-all" required>
                    <textarea id="lost-item-description" placeholder="Description (e.g., Contains student ID, brand)" class="w-full p-2 mb-2 border rounded-md" required></textarea>
                     <div class="flex items-center gap-2 mb-4">
                        <button type="button" id="generate-lost-desc-btn" class="w-full bg-purple-600 text-white p-2 rounded-md font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                            ✨ Generate Description
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                    <input type="text" id="lost-item-location" placeholder="Last Seen Location" class="w-full p-2 mb-4 border rounded-md" required>
                    <input type="email" id="lost-contact-email" placeholder="Your Contact Email" class="w-full p-2 mb-4 border rounded-md" required>
                    <button type="submit" class="w-full bg-red-500 text-white p-3 rounded-md font-semibold hover:bg-red-600 transition-colors">Report Lost Item</button>
                </form>
            </div>

            <!-- Report Found Item Form -->
            <div id="found-form-container" class="form-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Report a Found Item</h2>
                <form id="found-item-form">
                    <input type="text" id="found-item-name" placeholder="Item Name (e.g., Blue Umbrella)" class="w-full p-2 mb-4 border rounded-md transition-all" required>
                    <textarea id="found-item-description" placeholder="Description (e.g., Small logo on the handle)" class="w-full p-2 mb-2 border rounded-md" required></textarea>
                    <div class="flex items-center gap-2 mb-4">
                        <button type="button" id="generate-found-desc-btn" class="w-full bg-purple-600 text-white p-2 rounded-md font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50">
                           ✨ Generate Description
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                    <input type="text" id="found-item-location" placeholder="Location Found" class="w-full p-2 mb-4 border rounded-md" required>
                    <input type="email" id="found-contact-email" placeholder="Your Contact Email" class="w-full p-2 mb-4 border rounded-md" required>
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-md font-semibold hover:bg-green-600 transition-colors">Report Found Item</button>
                </form>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="mb-8 bg-white p-4 rounded-lg shadow-md">
            <input type="text" id="search-bar" placeholder="Search for an item..." class="w-full p-3 border rounded-md">
        </div>

        <!-- Items Display -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Lost Items Section -->
            <div>
                <h2 class="text-3xl font-bold mb-4 text-center">Lost Items</h2>
                <div id="lost-items-list" class="space-y-4">
                    <!-- Lost items will be dynamically inserted here from Firestore -->
                </div>
            </div>

            <!-- Found Items Section -->
            <div>
                <h2 class="text-3xl font-bold mb-4 text-center">Found Items</h2>
                <div id="found-items-list" class="space-y-4">
                    <!-- Found items will be dynamically inserted here from Firestore -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Item Details -->
    <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full m-4">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <p class="mb-2"><strong>Description:</strong> <span id="modal-description"></span></p>
            <p class="mb-2"><strong>Location:</strong> <span id="modal-location"></span></p>
            <p class="mb-2"><strong>Date Reported:</strong> <span id="modal-date"></span></p>
            <p class="mb-4"><strong>Contact:</strong> <a href="#" id="modal-contact" class="text-blue-500 hover:underline"></a></p>
            <button id="modal-close" class="w-full bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600">Close</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ====================================================================================
        // TODO: Add your Firebase project configuration object here.
        // Go to your Firebase project, click the "</>" icon for web apps,
        // and copy the config object here.
       const firebaseConfig = {
    apiKey: "AIzaSyCGEUePZzJiFN0s6qzYQYiQ60wiGiEB4J8",
    authDomain: "lost-and-found-22a08.firebaseapp.com",
    projectId: "lost-and-found-22a08",
    storageBucket: "lost-and-found-22a08.firebasestorage.app",
    messagingSenderId: "444324926925",
    appId: "1:444324926925:web:d865b978a44968782d2084",
    measurementId: "G-PDSRYNY87L"
  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const itemsCollection = collection(db, "items");

        // --- DOM Elements ---
        const lostItemForm = document.getElementById('lost-item-form');
        const foundItemForm = document.getElementById('found-item-form');
        const lostItemsList = document.getElementById('lost-items-list');
        const foundItemsList = document.getElementById('found-items-list');
        const searchBar = document.getElementById('search-bar');
        const itemModal = document.getElementById('item-modal');
        const modalClose = document.getElementById('modal-close');
        const generateLostDescBtn = document.getElementById('generate-lost-desc-btn');
        const generateFoundDescBtn = document.getElementById('generate-found-desc-btn');
        
        let allItems = []; // Local cache for searching

        // --- Real-time Data Listener from Firestore ---
        const q = query(itemsCollection, orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderItems(searchBar.value);
        });

        // --- Render Items ---
        const renderItems = (filter = '') => {
            lostItemsList.innerHTML = '';
            foundItemsList.innerHTML = '';
            const lowercasedFilter = filter.toLowerCase();
            
            const filteredItems = allItems.filter(item => 
                item.name.toLowerCase().includes(lowercasedFilter) ||
                item.description.toLowerCase().includes(lowercasedFilter)
            );

            if (allItems.length === 0) {
                 lostItemsList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-white rounded-lg shadow">No lost items reported yet.</p>';
                 foundItemsList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-white rounded-lg shadow">No found items reported yet.</p>';
                 return;
            }
            
            let lostCount = 0;
            let foundCount = 0;

            filteredItems.forEach(item => {
                const itemList = item.status === 'lost' ? lostItemsList : foundItemsList;
                if(item.status === 'lost') lostCount++; else foundCount++;
                
                const card = document.createElement('div');
                card.className = `item-card relative bg-white p-4 rounded-lg shadow-md cursor-pointer ${item.is_claimed ? 'opacity-60' : ''}`;
                
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${item.name}</h3>
                    <p class="text-gray-600 text-sm">${item.location}</p>
                    <p class="text-gray-500 text-xs mt-2">${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString() : 'Just now'}</p>
                    ${item.is_claimed ? '<div class="claimed-overlay">CLAIMED</div>' : ''}
                `;
                
                // Add "Claim" button for found items
                if (item.status === 'found' && !item.is_claimed) {
                    const claimButton = document.createElement('button');
                    claimButton.textContent = 'Claim Item';
                    claimButton.className = 'mt-4 w-full bg-blue-500 text-white p-2 rounded-md text-sm font-semibold hover:bg-blue-600 transition-colors';
                    claimButton.onclick = (e) => {
                        e.stopPropagation();
                        claimItem(item.id);
                    };
                    card.appendChild(claimButton);
                }

                // Add "Remove" button for lost items
                if (item.status === 'lost') {
                    const removeButton = document.createElement('button');
                    removeButton.textContent = 'I Found It! (Remove)';
                    removeButton.className = 'mt-4 w-full bg-gray-700 text-white p-2 rounded-md text-sm font-semibold hover:bg-gray-800 transition-colors';
                    removeButton.onclick = (e) => {
                        e.stopPropagation();
                        removeItem(item.id);
                    };
                    card.appendChild(removeButton);
                }

                card.addEventListener('click', () => showItemDetails(item.id));
                itemList.appendChild(card);
            });
            
            if (lostCount === 0) lostItemsList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-white rounded-lg shadow">No matching lost items found.</p>';
            if (foundCount === 0) foundItemsList.innerHTML = '<p class="text-gray-500 text-center p-4 bg-white rounded-lg shadow">No matching found items found.</p>';
        };
        
        // --- Firestore Actions ---
        const addItem = async (e, status) => {
            e.preventDefault();
            const name = document.getElementById(`${status}-item-name`).value;
            const description = document.getElementById(`${status}-item-description`).value;
            const location = document.getElementById(`${status}-item-location`).value;
            const contactEmail = document.getElementById(`${status}-contact-email`).value;
            
            try {
                await addDoc(itemsCollection, {
                    name, description, location, contactEmail, status,
                    is_claimed: false,
                    createdAt: serverTimestamp()
                });
                e.target.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        };

        const claimItem = async (id) => {
            const itemRef = doc(db, "items", id);
            try {
                await updateDoc(itemRef, { is_claimed: true });
            } catch (error) {
                console.error("Error updating document: ", error);
            }
        };

        const removeItem = async (id) => {
            const itemRef = doc(db, "items", id);
            try {
                await deleteDoc(itemRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        };

        const showItemDetails = (id) => {
            const item = allItems.find(i => i.id === id);
            if (item) {
                document.getElementById('modal-title').textContent = item.name;
                document.getElementById('modal-description').textContent = item.description;
                document.getElementById('modal-location').textContent = item.location;
                document.getElementById('modal-date').textContent = item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString() : 'Just now';
                const contactLink = document.getElementById('modal-contact');
                contactLink.textContent = item.contactEmail;
                contactLink.href = `mailto:${item.contactEmail}`;
                itemModal.classList.remove('hidden');
            }
        };

        // --- Gemini API Integration ---
        const callGeminiWithBackoff = async (prompt, maxRetries = 3) => {
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text.trim();
                    } else {
                       throw new Error("No content found in API response.");
                    }
                } catch (error) {
                    console.warn(`Attempt ${attempt + 1} failed:`, error.message);
                    attempt++;
                    if (attempt >= maxRetries) throw new Error("Max retries reached.");
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        };

        const generateDescription = async (status) => {
            const generateBtn = document.getElementById(`generate-${status}-desc-btn`);
            const loader = generateBtn.querySelector('.loader');
            const itemNameInput = document.getElementById(`${status}-item-name`);
            const descriptionTextarea = document.getElementById(`${status}-item-description`);
            const itemName = itemNameInput.value;
            if (!itemName) {
                itemNameInput.focus();
                itemNameInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                setTimeout(() => itemNameInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200'), 2500);
                return;
            }
            loader.classList.remove('hidden');
            generateBtn.disabled = true;
            const prompt = `Generate a clear and concise description for a campus lost and found report. The item is a "${itemName}". The description should be helpful for someone trying to identify the item. Do not add any preamble like "Here is a description:".`;
            try {
                const generatedText = await callGeminiWithBackoff(prompt);
                descriptionTextarea.value = generatedText;
            } catch (error) {
                console.error('Error generating description:', error);
                descriptionTextarea.placeholder = "AI generation failed. Please write a description manually.";
            } finally {
                loader.classList.add('hidden');
                generateBtn.disabled = false;
            }
        };

        // --- Event Listeners ---
        lostItemForm.addEventListener('submit', (e) => addItem(e, 'lost'));
        foundItemForm.addEventListener('submit', (e) => addItem(e, 'found'));
        searchBar.addEventListener('input', (e) => renderItems(e.target.value));
        modalClose.addEventListener('click', () => itemModal.classList.add('hidden'));
        generateLostDescBtn.addEventListener('click', () => generateDescription('lost'));
        generateFoundDescBtn.addEventListener('click', () => generateDescription('found'));
    </script>
</body>
</html>
